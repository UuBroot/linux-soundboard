app-id: com.uubroot.Soundboard
runtime: org.kde.Platform
runtime-version: '6.9'
sdk: org.kde.Sdk//6.9
base: io.qt.PySide.BaseApp
base-version: '6.9'
command: start-app
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --device=dri
  - --share=network
  - --socket=pulseaudio
  - --filesystem=xdg-run/pipewire-0
  - --filesystem=xdg-music/Sounds:rw

modules:
  - name: libsndfile
    sources:
      - type: archive
        url: https://github.com/libsndfile/libsndfile/releases/download/1.2.2/libsndfile-1.2.2.tar.xz
        sha256: 3799ca9924d3125038880367bf1468e53a1b7e3686a934f098b7e1d286cdb80e
    cleanup:
      - /bin
      - /include

  - name: portaudio
    config-opts:
      - --with-alsa
      - --without-jack
      - --without-oss
    sources:
      - type: archive
        url: https://files.portaudio.com/archives/pa_stable_v190700_20210406.tgz
        sha256: 47efbf42c77c19a05d22e627d42873e991ec0c1357219c0d74ce6a2948cb2def
    cleanup:
      - /include
      - /lib/pkgconfig

  - name: python3-packaging
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "packaging>=24.2" --ignore-installed --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/20/12/38679034af332785aac8774540895e234f4d07f7545804097de4b666afd8/packaging-25.0-py3-none-any.whl
        sha256: 29572ef2b1f17581046b3a2227d5c611fb25ec70ca1ba8554b24b0e69331a484

  - python-deps.json
  - name: soundboard-app
    buildsystem: simple
    build-commands:
      # 1. Create the destination directory
      - mkdir -p /app/lib/soundboard
      # 2. Copy everything to that directory
      - cp -R . /app/lib/soundboard/
      # 3. Create a launcher script in /app/bin
      - |
        cat <<EOF > /app/bin/start-app
        #!/bin/sh
        # Link the C-libraries compiled in /app/lib (PortAudio, libsndfile)
        export LD_LIBRARY_PATH="/app/lib:\${LD_LIBRARY_PATH}"
        # Link your Python code
        export PYTHONPATH="/app/lib/soundboard:\${PYTHONPATH}"
        exec python3 /app/lib/soundboard/main.py "\$@"
        EOF
      # 4. Make the launcher executable
      - chmod +x /app/bin/start-app
    sources:
      - type: dir
        path: .